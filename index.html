<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stripe Reconciler</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-8 text-center">
                Stripe Reconciler
            </h1>
            
            <p class="text-gray-600 mb-8 text-center">
                Upload your Stripe balance and payouts CSV files to generate a FreeAgent-compatible reconciliation file.
            </p>

            <div class="space-y-6">
                <!-- File Upload Section -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label for="balance-file" class="block text-sm font-medium text-gray-700">
                            Stripe Balance CSV File
                        </label>
                        <input
                            id="balance-file"
                            type="file"
                            accept=".csv"
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                        />
                        <p class="text-xs text-gray-500">
                            Select the Stripe balance itemised activity CSV file
                        </p>
                    </div>

                    <div class="space-y-2">
                        <label for="payouts-file" class="block text-sm font-medium text-gray-700">
                            Stripe Payouts CSV File
                        </label>
                        <input
                            id="payouts-file"
                            type="file"
                            accept=".csv"
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                        />
                        <p class="text-xs text-gray-500">
                            Select the Stripe payouts CSV file
                        </p>
                    </div>
                </div>

                <!-- Process Button -->
                <div class="flex justify-center">
                    <button
                        id="process-btn"
                        class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    >
                        Process Files
                    </button>
                </div>

                <!-- Status Display -->
                <div id="status" class="hidden"></div>

                <!-- Error Display -->
                <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4">
                    <p id="error-text" class="text-red-800"></p>
                </div>

                <!-- Result Display -->
                <div id="result" class="hidden bg-green-50 border border-green-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-green-800 mb-4">
                        Processing Complete!
                    </h3>
                    <p class="text-green-700 mb-4">
                        Your FreeAgent-compatible CSV has been generated. Click the button below to download it.
                    </p>
                    <button
                        id="download-btn"
                        class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors"
                    >
                        Download freeagent.csv
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CSV Processing Logic
        function parse_csv_line(line) {
            const result = [];
            let current = '';
            let in_quotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    in_quotes = !in_quotes;
                } else if (char === ',' && !in_quotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function parse_balance_csv(csv_text) {
            const lines = csv_text.split('\n');
            const transactions = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = parse_csv_line(line);
                if (values.length < 15) continue;

                const transaction = {
                    balance_transaction_id: values[0]?.replace(/"/g, '') || '',
                    created: values[2]?.replace(/"/g, '') || '',
                    gross: values[6]?.replace(/"/g, '') || '',
                    fee: values[7]?.replace(/"/g, '') || '',
                    reporting_category: values[9]?.replace(/"/g, '') || '',
                    trace_id: values[14]?.replace(/"/g, '') || '',
                    description: values[11]?.replace(/"/g, '') || ''
                };

                transactions.push(transaction);
            }

            return transactions;
        }

        function parse_payouts_csv(csv_text) {
            const lines = csv_text.split('\n');
            const transactions = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                const values = parse_csv_line(line);
                if (values.length < 18) continue;

                const transaction = {
                    payout_id: values[0]?.replace(/"/g, '') || '',
                    effective_at: values[2]?.replace(/"/g, '') || '',
                    gross: values[5]?.replace(/"/g, '') || '',
                    trace_id: values[17]?.replace(/"/g, '') || ''
                };

                transactions.push(transaction);
            }

            return transactions;
        }

        function transform_to_freeagent_format(balance_transactions, payout_transactions) {
            const freeagent_transactions = [];

            // Process balance transactions
            for (const transaction of balance_transactions) {
                const gross_amount = parseFloat(transaction.gross);
                const fee_amount = parseFloat(transaction.fee);
                const created_date = new Date(transaction.created);

                // Format date as DD/MM/YYYY
                const date_str = created_date.toLocaleDateString('en-GB');

                // Add sale transaction (positive amount)
                if (transaction.reporting_category === 'charge') {
                    freeagent_transactions.push({
                        date: date_str,
                        amount: gross_amount.toFixed(2),
                        description: `sale ${transaction.trace_id} ${transaction.balance_transaction_id}`
                    });

                    // Add fee transaction (negative amount)
                    if (fee_amount > 0) {
                        freeagent_transactions.push({
                            date: date_str,
                            amount: (-fee_amount).toFixed(2),
                            description: `fee ${transaction.trace_id} ${transaction.balance_transaction_id}`
                        });
                    }
                } else if (transaction.reporting_category === 'refund') {
                    // Add refund transaction (negative amount)
                    freeagent_transactions.push({
                        date: date_str,
                        amount: (-gross_amount).toFixed(2),
                        description: `refund ${transaction.trace_id} ${transaction.balance_transaction_id}`
                    });
                }
            }

            // Process payout transactions
            for (const transaction of payout_transactions) {
                const gross_amount = parseFloat(transaction.gross);
                const effective_date = new Date(transaction.effective_at);
                const date_str = effective_date.toLocaleDateString('en-GB');

                if (gross_amount > 0) {
                    // Positive payout becomes negative transfer
                    freeagent_transactions.push({
                        date: date_str,
                        amount: (-gross_amount).toFixed(2),
                        description: `transfer ${transaction.trace_id} ${transaction.payout_id}`
                    });
                } else {
                    // Negative payout becomes positive stripe debit
                    freeagent_transactions.push({
                        date: date_str,
                        amount: (-gross_amount).toFixed(2),
                        description: `stripe debit ${transaction.trace_id} ${transaction.payout_id}`
                    });
                }
            }

            // Sort by date
            freeagent_transactions.sort((a, b) => {
                const date_a = new Date(a.date.split('/').reverse().join('-'));
                const date_b = new Date(b.date.split('/').reverse().join('-'));
                return date_a.getTime() - date_b.getTime();
            });

            return freeagent_transactions;
        }

        function generate_freeagent_csv(transactions) {
            const lines = transactions.map(t => `${t.date},${t.amount},${t.description}`);
            return lines.join('\n');
        }

        async function process_csv_files(balance_file, payouts_file) {
            const balance_text = await balance_file.text();
            const payouts_text = await payouts_file.text();

            const balance_transactions = parse_balance_csv(balance_text);
            const payout_transactions = parse_payouts_csv(payouts_text);

            const freeagent_transactions = transform_to_freeagent_format(balance_transactions, payout_transactions);

            return generate_freeagent_csv(freeagent_transactions);
        }

        // UI Event Handlers
        let csv_result = null;

        document.getElementById('process-btn').addEventListener('click', async () => {
            const balance_file = document.getElementById('balance-file').files[0];
            const payouts_file = document.getElementById('payouts-file').files[0];

            if (!balance_file || !payouts_file) {
                show_error('Please select both balance and payouts files');
                return;
            }

            const process_btn = document.getElementById('process-btn');
            const status_div = document.getElementById('status');
            const error_div = document.getElementById('error');
            const result_div = document.getElementById('result');

            // Reset UI
            hide_error();
            hide_result();
            process_btn.disabled = true;
            process_btn.textContent = 'Processing...';
            show_status('Processing files...');

            try {
                csv_result = await process_csv_files(balance_file, payouts_file);
                hide_status();
                show_result();
            } catch (err) {
                show_error(err.message || 'An error occurred while processing files');
            } finally {
                process_btn.disabled = false;
                process_btn.textContent = 'Process Files';
            }
        });

        document.getElementById('download-btn').addEventListener('click', () => {
            if (!csv_result) return;

            const blob = new Blob([csv_result], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'freeagent.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        function show_error(message) {
            document.getElementById('error-text').textContent = message;
            document.getElementById('error').classList.remove('hidden');
        }

        function hide_error() {
            document.getElementById('error').classList.add('hidden');
        }

        function show_result() {
            document.getElementById('result').classList.remove('hidden');
        }

        function hide_result() {
            document.getElementById('result').classList.add('hidden');
        }

        function show_status(message) {
            const status_div = document.getElementById('status');
            status_div.textContent = message;
            status_div.classList.remove('hidden');
        }

        function hide_status() {
            document.getElementById('status').classList.add('hidden');
        }
    </script>
</body>
</html> 